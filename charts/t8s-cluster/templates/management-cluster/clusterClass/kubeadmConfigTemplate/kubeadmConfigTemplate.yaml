apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: {{ printf "%s-worker" $.Release.Name }}
  namespace: {{ $.Release.Namespace }}
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          kubeletExtraArgs: {{- include "t8s-cluster.clusterClass.kubeletExtraArgs" $ | nindent 12 }}
          name: '{{ `{{ local_hostname }}` }}'
        patches:
          directory: /etc/kubernetes/patches
      files: {{- include "t8s-cluster.patches.kubelet.patches" . | nindent 8 }}
        {{- if .Values.containerRegistryProxy.proxyRegistryEndpoint }}
          {{- include "t8s-cluster.clusterClass.containerdConfig.containerRegistryProxyConfigs" (dict "context" $) | nindent 8 }}
        {{- end }}
        {{- if .Values.global.injectedCertificateAuthorities }}
        - content: |- {{- .Values.global.injectedCertificateAuthorities | nindent 12 }}
          path: /usr/local/share/ca-certificates/injected-ca-certs.crt
        {{- end }}
      {{ if .Values.global.injectedCertificateAuthorities -}}
      preKubeadmCommands:
        - update-ca-certificates
      {{- end }}
      postKubeadmCommands: {{- include "t8s-cluster.clusterClass.postKubeadmCommands" (dict) | nindent 8 }}
