{{/*
KubeadmControlPlaneTemplate is immutable. We need to create new versions during upgrades.
Here we are generating a hash suffix.
This function needs the whole `$` context to be able to use `.Files.Get`
*/}}
{{- define "t8s-cluster.clusterClass.k0smotronControlPlaneTemplate.spec" -}}
replicas: {{ $.Values.controlPlane.singleNode | ternary 1 3 }}
service:
  type: LoadBalancer
  apiPort: 6443
  konnectivityPort: 8132
controllerPlaneFlags:
  - --disable-components=metrics-server
k0sConfig:
  apiVersion: k0s.k0sproject.io/v1beta1
  kind: ClusterConfig
  spec:
    network:
      provider: custom
    api:
      extraArgs:
        cloud-provider: external
        enable-admission-plugins: AlwaysPullImages,NodeRestriction
        profiling: 'false'
        tls-cipher-suites: {{ include "t8s-cluster.clusterClass.tlsCipherSuites" (dict) }}
        event-ttl: 4h
    controllerManager:
      extraArgs:
        authorization-always-allow-paths: /healthz,/readyz,/livez,/metrics
        bind-address: 0.0.0.0
        cloud-provider: external
        profiling: 'false'
        terminated-pod-gc-threshold: '100'
    scheduler:
      extraArgs:
        authorization-always-allow-paths: /healthz,/readyz,/livez,/metrics
        bind-address: 0.0.0.0
        profiling: 'false'
    telemetry:
      enabled: false
etcd:
  persistence:
    size: 5Gi
{{- end -}}
