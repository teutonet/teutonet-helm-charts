{{/*
KubeadmControlPlaneTemplate is immutable. We need to create new versions during upgrades.
Here we are generating a hash suffix.
This function needs the whole `$` context to be able to use `.Files.Get`
*/}}
{{- define "t8s-cluster.clusterClass.hostedControlPlaneTemplate.spec" -}}
deployment:
  apiServer:
    mounts:
      config:
        path: {{ include "t8s-cluster.clusterClass.configPath" (dict) }}
        configMap:
          name: {{ printf "%s-apiserver" $.Release.Name }}
          {{- $items := list -}}
          {{- range $name, $file := mustMerge (include "t8s-cluster.clusterClass.apiServer.staticFiles" (dict) | fromYaml) (include "t8s-cluster.clusterClass.apiServer.dynamicFiles" (dict "context" .) | fromYaml) -}}
            {{- $items = append $items (dict "key" $name "path" (get $file "fileName" | required (printf "missing fileName for %s" $file))) -}}
          {{- end }}
          items: {{- toYaml $items | nindent 10 }}
    args: {{- include "t8s-cluster.clusterClass.args.apiServer" (dict "context" .) | nindent 6 }}
    resources: {{- include "common.resources" .Values.controlPlane | nindent 6 }}
    audit:
      webhook:
        targets:
          - server: https://k8s.master.wazuh.teuto.net/{{ .Release.Namespace }}/{{ .Release.Name }}
            authentication:
              secretName: wazuh-audit-webhook
              secretNamespace: capi-hosted-control-plane-system
      policy:
        # Long-running requests like watches will not generate an audit event in RequestReceived.
        omitStages:
          - RequestReceived
        rules:
          - level: None
            users:
              - system:kube-controller-manager
              - system:kube-scheduler
              - system:apiserver
          - level: None
            resources:
              - group: coordination.k8s.io
                resources:
                  - leases
              - group: ""
                resources:
                  - events
          - level: Metadata
            verbs: [] # All verbs
            resources:
              - group: ""
                resources:
                  - secrets
          - level: Metadata
            verbs:
              - create
              - update
              - patch
              - delete
              - deletecollection
            resources: [] # All resources
  controllerManager:
    args: {{- include "t8s-cluster.clusterClass.args.controllerManager" (dict "context" .) | nindent 6 }}
    resources: {{- include "common.resources" .Values.controlPlane | nindent 6 }}
    replicas: 1
  scheduler:
    args: {{- include "t8s-cluster.clusterClass.args.scheduler" (dict) | nindent 6 }}
    resources: {{- include "common.resources" .Values.controlPlane | nindent 6 }}
    replicas: 1
gateway:
  namespace: capi-hosted-control-plane-system
  name: controlplane
{{- end -}}
