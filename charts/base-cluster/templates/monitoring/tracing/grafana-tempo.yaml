{{- if and .Values.monitoring.tracing.enabled .Values.monitoring.prometheus.enabled -}}
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana-tempo
  namespace: monitoring
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: tracing
    app.kubernetes.io/part-of: monitoring
spec:
  chart:
    spec: {{- include "base-cluster.helm.chartSpec" (dict "repo" "bitnami" "chart" "grafana-tempo" "context" $) | nindent 6 }}
  interval: 1h
  driftDetection:
    mode: enabled
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
  values:
    {{- if .Values.global.imageRegistry }}
    global:
      imageRegistry: {{ $.Values.global.imageRegistry }}
    {{- end }}
    ingester: {{- include "common.resourcesWithPreset" .Values.monitoring.tracing.ingester | nindent 6 }}
    tempo:
      traces:
        jaeger:
          grpc: false
          thriftHttp: false
        otlp:
          grpc: true
      resources:
        limits:
          cpu: 50m
          memory: 50Mi
        requests:
          cpu: 10
          memory: 30Mi
    ingester:
      resources:
        limits:
          cpu: 50m
          memory: 50Mi
        requests:
          cpu: 10
          memory: 30Mi
    query:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    querier:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    distributor:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    memcached:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    compactor:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    metricsGenerator:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    queryFrontend:
      resources:
        limits:
          cpu: 50m
          memory: 100Mi
        requests:
          cpu: 10
          memory: 70Mi
    vulture:
      resources:
        limits:
          cpu: 100m
          memory: 250Mi
        requests:
          cpu: 10
          memory: 100Mi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        labels: {{- toYaml .Values.monitoring.labels | nindent 10 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-tempo-datasource
  namespace: monitoring
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: tracing
    app.kubernetes.io/part-of: monitoring
    grafana_datasource: "1"
data:
  grafana-tempo-datasource.yaml: |-
    apiVersion: 1
    datasources:
      - name: Tempo
        type: tempo
        access: proxy
        uid: tempo
        url: "http://grafana-tempo-query-frontend.monitoring:3200"
        version: 1
        isDefault: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
          tracesToMetrics:
            datasourceUid: prometheus
          nodeGraph:
            enabled: true
          serviceMap:
            datasourceUid: prometheus
          lokiSearch:
            datasourceUid: loki
{{- end -}}
