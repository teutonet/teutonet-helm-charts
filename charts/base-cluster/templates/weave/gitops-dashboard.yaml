{{- if .Values.weaveworks.enabled }}
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  annotations:
    metadata.weave.works/description: This is the Weave GitOps Dashboard.  It provides
      a simple way to get insights into your GitOps workloads.
  name: gitops-dashboard
  namespace: weave
spec:
  chart:
    spec: {{- include "base-cluster.helm.chartSpec" (dict "repo" "weaveworks" "chart" "weave-gitops" "context" $) | nindent 6 }}
  interval: 5m
  values:
    replicaCount: 1
    {{- if .Values.weaveworks.adminUser }}
    adminUser:
      create: true
      username: {{ .Values.weaveworks.adminUser.username }}
      createSecret: true
      {{- if .Values.weaveworks.adminUser.password }}
      passwordHash: {{  .Values.weaveworks.adminUser.password | bcrypt }}
      {{- end }}
    {{- end }}
    {{- if and .Values.weaveworks.ingress .Values.weaveworks.ingress.enabled }}
    ingress:
      enabled: true
      host: {{ .Values.weaveworks.ingress.host }}
    {{- end }}
    metrics:
      enabled: {{ .Values.monitoring.prometheus.enabled }}
    {{- with .Values.global.authentication }}
    {{- if .config.clientId }}
    oidcSecret:
      create: true
      clientID: {{ .config.clientId }}
      issuerURL: {{ printf "https://%s%s" .config.issuerHost .config.issuerPath }}
      clientSecret: {{ .config.clientSecret }}
      redirectURL: {{printf "%s/oauth2/callback" $.Values.weaveworks.ingress.host }}
    {{- end }}
    {{- end }}
{{- end }}