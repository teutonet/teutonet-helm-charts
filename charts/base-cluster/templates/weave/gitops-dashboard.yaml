{{- if .Values.weaveworks.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: weave
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  annotations:
    metadata.weave.works/description: This is the Weave GitOps Dashboard.  It provides
      a simple way to get insights into your GitOps workloads.
  name: gitops-dashboard
  namespace: weave
spec:
  chart:
    spec:
      chart: weave-gitops
      sourceRef:
        kind: HelmRepository
        name: weaveworks
        namespace: flux-system
  interval: 5m
  values:
    replicaCount: 1
    {{- if and .Values.weaveworks.adminUser .Values.weaveworks.adminUser.create }}
    adminUser:
      create: true
      username: {{ .Values.weaveworks.adminUser.username }}
      createSecret: true
      {{- if .Values.weaveworks.adminUser.password }}
      passwordHash: {{  .Values.weaveworks.adminUser.password | bcrypt }}
      {{- end }}
    {{- end }}
    {{- if and .Values.weaveworks.ingress .Values.weaveworks.ingress.enabled }}
    ingress:
      enabled: true
      host: {{ .Values.weaveworks.ingress.host }}
    {{- end }}
    metrics:
      enabled: {{ .Values.monitoring.prometheus.enabled }}
    {{- with .Values.global.authentication }}
    oidcSecret:
      create: true
      {{- if .config.clientId }}
      issuerURL: {{ printf "https://%s%s" .config.issuerHost .config.issuerPath }}
      clientID: {{ .config.clientId }}
      clientSecret: {{ .config.clientSecret }}
      redirectURL: {{printf "%s/oauth2/callback" $.Values.weaveworks.ingress.host }}
      {{- end }}
    {{- end }}
{{- end }}