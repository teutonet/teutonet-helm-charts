{{- if .Values.backup.enabled }}
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: backup
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  chart:
    spec: {{- include "base-cluster.helm.chartSpec" (dict "repo" "vmware" "chart" "velero" "context" $) | nindent 6 }}
  interval: 1h
  {{- if .Values.monitoring.prometheus.enabled }}
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
  {{- end }}
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    image:
      repository: {{ printf "%s/velero/velero" ($.Values.global.imageRegistry | default (include "base-cluster.defaultRegistry" (dict))) }}
    kubectl:
      image:
        repository: {{ printf "%s/bitnami/kubectl" ($.Values.global.imageRegistry | default (include "base-cluster.defaultRegistry" (dict))) }}
    upgradeCRDs: false
    cleanUpCRDs: true
    initContainers:
      - name: velero-plugin-for-aws
        image: docker.io/velero/velero-plugin-for-aws:v1.7.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
    podSecurityContext:
      fsGroup: 1000
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
    containerSecurityContext:
      readOnlyRootFilesystem: true
      privileged: false
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
    resources: {{- .Values.backup.resources | toYaml | nindent 6 }}
    priorityClassName: system-cluster-critical
    deployNodeAgent: true # enable FSB
    nodeAgent:
      resources: {{- .Values.backup.nodeAgent.resources | toYaml | nindent 8 }}
    configuration:
      {{- if .Values.backup.backupStorageLocations }}
      backupStorageLocation: {{- range $name, $spec := .Values.backup.backupStorageLocations }}
        {{- $providerName := include "base-cluster.backup.getProviderName" $spec.provider }}
        - name: {{ $name | quote }}
          provider: {{ include "base-cluster.backup.mapProviderName" $providerName | quote }}
          bucket: {{ $spec.bucket | quote }}
          {{- if $spec.prefix }}
          prefix: {{ $spec.prefix | quote }}
          {{- end }}
          {{- if $.Values.backup.defaultLocation }}
          default: {{ eq $name $.Values.backup.defaultLocation }}
          {{- end }}
          {{- $credentialType := include "base-cluster.backup.credentialType" $spec.provider }}
          {{- if eq $credentialType "direct" }}
          credential:
            name: {{ printf "%s-velero-backuplocation-%s" (include "common.names.fullname" $) $name }}
            key: {{ $providerName }}
          {{- else if eq $credentialType "existingSecret" }}
            {{- $existingSecret := dig $providerName "existingSecret" (dict) $spec.provider }}
          credential:
            name: {{ get $existingSecret "name" | required (printf "You need to provide the existingSecret.name for %s" $name) }}
            key: {{ get $existingSecret "key" | default (printf "%s-%s" $providerName $name) }}
          {{- end }}
          {{- if eq $providerName "minio" }}
          {{- $providerSpec := get $spec.provider $providerName }}
          config:
            region: {{ ($providerSpec.region | default "Region1") | quote }}
            s3ForcePathStyle: {{ $providerSpec.forcePathStyle | default true }}
            s3Url: {{ $providerSpec.url | quote }}
          {{- end }}
      {{- end }}
      {{- else }}
      backupStorageLocation: []
      {{- end }}
      volumeSnapshotLocation: []
    metrics:
      serviceMonitor:
        additionalLabels: {{- .Values.monitoring.labels | toYaml | nindent 10 }}
---
  {{- if hasPrefix "4." (dig "spec" "chart" "spec" "version" "" (lookup "helm.toolkit.fluxcd.io/v2beta1" "HelmRelease" "backup" "velero")) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: remove-backup-storage-locations
  namespace: backup
  labels: {{- include "common.labels.standard" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      automountServiceAccountToken: true
      serviceAccountName: remove-backup-storage-locations
      securityContext:
        runAsNonRoot: true
        runAsGroup: 1000
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: remove-backup-storage-locations
          image: {{ include "common.images.image" (dict "imageRoot" .Values.global.kubectl.image "global" .Values.global) }}
          {{- if .Values.global.kubectl.image.digest }}
          imagePullPolicy: IfNotPresent
          {{- else }}
          imagePullPolicy: Always
          {{- end }}
          securityContext:
            readOnlyRootFilesystem: true
            privileged: false
            capabilities:
              drop:
                - ALL
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
          command:
            - bash
            - -ex
            - -c
            - |
              kubectl get backupstoragelocations # test if RBAC is working
              for NAME in {{ .Values.backup.backupStorageLocations | keys | join " " }}; do
                if kubectl get backupstoragelocation $NAME >/dev/null; then
                  kubectl delete backupstoragelocation $NAME
                fi
              done
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: remove-backup-storage-locations
  namespace: backup
  labels: {{- include "common.labels.standard" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: remove-backup-storage-locations
  namespace: backup
  labels: {{- include "common.labels.standard" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
rules:
  - verbs:
      - list
      - get
      - delete
    resources:
      - backupstoragelocations
    apiGroups:
      - velero.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: remove-backup-storage-locations
  namespace: backup
  labels: {{- include "common.labels.standard" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
subjects:
  - kind: ServiceAccount
    name: remove-backup-storage-locations
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: remove-backup-storage-locations
  {{- end }}
{{- end }}
