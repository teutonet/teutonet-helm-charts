{{- if .Values.backup.backupStorageLocations }}
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: velero
  namespace: backup
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  chart:
    spec: {{- include "base-cluster.helm.chartSpec" (dict "repo" "vmware" "chart" "velero" "context" $) | nindent 6 }}
  interval: 1h
  driftDetection:
    mode: enabled
  {{- if .Values.monitoring.prometheus.enabled }}
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
  {{- end }}
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    image:
      repository: {{ printf "%s/velero/velero" ($.Values.global.imageRegistry | default (include "base-cluster.defaultRegistry" (dict))) }}
    kubectl:
      image:
        repository: {{ printf "%s/bitnami/kubectl" ($.Values.global.imageRegistry | default (include "base-cluster.defaultRegistry" (dict))) }}
    upgradeCRDs: false
    cleanUpCRDs: true
    initContainers:
      - name: velero-plugin-for-aws
        image: {{ printf "%s/velero/velero-plugin-for-aws:v1.7.0" (.Values.global.imageRegistry | default "docker.io") }}
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
        securityContext: &containerSecurityContext
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          privileged: false
          readOnlyRootFilesystem: true
          seccompProfile:
            type: RuntimeDefault
    podSecurityContext:
      fsGroup: 1000
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
    containerSecurityContext: *containerSecurityContext
    resources: {{- .Values.backup.resources | toYaml | nindent 6 }}
    priorityClassName: system-cluster-critical
    deployNodeAgent: true # enable FSB
    nodeAgent:
      resources: {{- .Values.backup.nodeAgent.resources | toYaml | nindent 8 }}
      priorityClassName: system-cluster-critical
      privileged: false
      podSecurityContext:
        fsGroup: 1337
      containerSecurityContext:
        <<: *containerSecurityContext
        capabilities:
          add:
            - NET_BIND_SERVICE # needed until https://github.com/vmware-tanzu/velero/pull/6784 gets released
      extraVolumes:
        - name: tmp
          emptyDir: {}
      extraVolumeMounts:
        - name: tmp
          mountPath: /tmp
    configuration:
      defaultBackupStorageLocation: {{ .Values.backup.defaultLocation | quote }}
      backupStorageLocation: {{- range $name, $spec := .Values.backup.backupStorageLocations }}
        {{- $providerName := include "base-cluster.backup.getProviderName" $spec.provider }}
        - name: {{ $name | quote }}
          provider: {{ include "base-cluster.backup.mapProviderName" $providerName | quote }}
          bucket: {{ $spec.bucket | quote }}
          {{- if $spec.prefix }}
          prefix: {{ $spec.prefix | quote }}
          {{- end }}
          default: {{ eq $name $.Values.backup.defaultLocation }}
          {{- $credentialType := include "base-cluster.backup.credentialType" $spec.provider }}
          {{- if eq $credentialType "direct" }}
          credential:
            name: {{ printf "%s-velero-backuplocation-%s" (include "common.names.fullname" $) $name }}
            key: {{ $providerName }}
          {{- else if eq $credentialType "existingSecret" }}
            {{- $existingSecret := dig $providerName "existingSecret" (dict) $spec.provider }}
          credential:
            name: {{ get $existingSecret "name" | required (printf "You need to provide the existingSecret.name for %s" $name) }}
            key: {{ get $existingSecret "key" | default (printf "%s-%s" $providerName $name) }}
          {{- end }}
          {{- if eq $providerName "minio" }}
          {{- $providerSpec := get $spec.provider $providerName }}
          config:
            region: {{ ($providerSpec.region | default "Region1") | quote }}
            s3ForcePathStyle: {{ $providerSpec.forcePathStyle | default true }}
            s3Url: {{ $providerSpec.url | quote }}
          {{- end }}
      {{- end }}
      volumeSnapshotLocation: []
      uploaderType: restic
    metrics:
      serviceMonitor:
        additionalLabels: {{- .Values.monitoring.labels | toYaml | nindent 10 }}
{{- end }}
