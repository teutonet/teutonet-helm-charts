{{- if .Values.kyverno.enabled }}
# https://github.com/kyverno/kyverno/tree/main/charts/kyverno-policies
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kyverno-policies
  namespace: kyverno
  labels: {{- include "common.labels.standard" $ | nindent 4 }}
    app.kubernetes.io/component: kyverno-policies
    app.kubernetes.io/part-of: kyverno
spec:
  chart:
    spec:
      chart: kyverno-policies
      version: 2.x.x
      sourceRef:
        kind: HelmRepository
        name: kyverno
        namespace: {{ .Release.Namespace }}
  interval: 5m
  dependsOn:
    - name: kyverno
      namespace: kyverno
  values:
    # Supported- baseline/restricted/privileged/custom
    # For more info- https://kyverno.io/policies/pod-security
    podSecurityStandard: {{ .Values.kyverno.podSecurityStandard | quote }}
    # Supported- low/medium/high
    podSecuritySeverity: {{ .Values.kyverno.podSecuritySeverity | quote }}
    # Supported values- `audit`, `enforce`
    # For more info- https://kyverno.io/docs/writing-policies/validate/
    validationFailureAction: {{ .Values.kyverno.validationFailureAction | quote }}
    {{- if and .Values.monitoring.prometheus.enabled .Values.monitoring.loki.enabled }}
    policyExclude:
      disallow-host-path:
        resources:
          namespaces:
            - loki
    {{- end }}
{{- end }}