name: Get changed charts in last commit

on:
  workflow_call:
    inputs:
      forPR:
        type: boolean
        required: true
        description: If it should run against the default branch instead of the last commit
    outputs:
      charts:
        description: The names of the changed charts in the last commit
        value: ${{ jobs.getChangedCharts.outputs.charts }}

jobs:
  getChangedCharts:
    runs-on: ubuntu-22.04
    outputs:
      charts: ${{ steps.getCharts.outputs.charts }}
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: helm/chart-testing-action@v2.4.0

      - name: Get all charts
        id: getCharts
        env:
          FOR_PR: ${{ inputs.forPR }}
        run: |
          set -ex
          set -o pipefail
          (
            echo -n charts=
            ct_flags=( list-changed )
            if [[ "$FOR_PR" == "true" ]]; then
              ct_flags+=( --since=HEAD~ )
            fi
            ct "${ct_flags[@]}" | cut -d / -f 2 | jq -c -Rn '[inputs]'
          ) | tee "$GITHUB_OUTPUT"
