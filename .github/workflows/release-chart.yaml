name: Release Chart

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      - charts/*/Chart.yaml

jobs:
  getChangedChart:
    if: ${{ contains(github.event.head_commit.message, '[bot] release') || github.event.name != 'push' }}
    uses: ./.github/workflows/get-changed-chart.yaml
  release:
    if: ${{ contains(github.event.head_commit.message, '[bot] release') || github.event.name != 'push' }}
    runs-on: ubuntu-latest
    needs: getChangedChart
    steps:
      - uses: actions/checkout@v4

      - run: pip install yq
      - name: Extract and add helm repos
        id: helm-repos
        env:
          CHART: ${{ needs.getChangedChart.outputs.chart }}
        run: |
          set -ex
          set -o pipefail
          chart_dir="charts/${CHART}"
          file="${chart_dir}/Chart.yaml"
          yq -r '.dependencies[] | .repository' "$file" | sort -u | awk '{print NR " " $1}' | xargs -r -n 2 helm repo add

      - run: helm package --dependency-update charts/${{ needs.getChangedChart.outputs.chart }}
      - run: helm registry login ghcr.io --username teutonet-bot --password ${{ secrets.ACTIONS_BOT_TOKEN }}
      - run: helm push ${{ needs.getChangedChart.outputs.chart }}-* "oci://ghcr.io/${GITHUB_REPOSITORY}"

      - uses: google-github-actions/release-please-action@v4
        with:
          skip-github-pull-request: true
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}
          config-file: .github/release-please/config.json
          manifest-file: .github/release-please/manifest.json
