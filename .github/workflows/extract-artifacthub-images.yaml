name: Extract images from charts for ArtifactHUB

on:
  push:
    branches:
      - release-please--**
    paths:
      - charts/*/Chart.yaml
  schedule:
    - cron: '0 0 * * *'

jobs:
  extractImages:
    if: ${{ !contains(github.event.workflow_run.head_commit.message, '[bot] Update images') }}
    runs-on: ubuntu-22.04
    outputs:
      changedCharts: ${{ steps.getChangedCharts.outputs.changedCharts }}
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - run: pip install yq
      - name: Install sponge
        run: sudo apt-get -yq install moreutils
      - uses: helm/chart-testing-action@v2.3.1

      - name: extract images
        run: ./.github/scripts/extract-artifacthub-images.sh

      - name: Get changed charts
        id: getChangedCharts
        run: |
          set -x
          set -o pipefail
          (
            echo -n changedCharts=
            ct list-changed | cut -d / -f 2 | jq -c -Rn '[inputs]'
          ) | tee $GITHUB_OUTPUT
      - name: Commit Change for single chart
        if: ${{ contains(github.ref, 'release-please--') }}
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: [bot] Update images in 'Chart.yaml'"
          default_author: github_actions
          pull: --rebase --autostash

  extractImagesForMultipleCharts:
    if: ${{ !contains(github.ref, 'release-please--') }}
    runs-on: ubuntu-22.04
    needs:
      - extractImages
    strategy:
      matrix:
        chart: ${{ fromJson(needs.extractImages.outputs.changedCharts) }}
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - run: pip install yq
      - name: Install sponge
        run: sudo apt-get -yq install moreutils

      - name: extract images for ${{ matrix.chart }}
        run: ./.github/scripts/extract-artifacthub-images.sh "${{ matrix.chart }}"
      - uses: EndBug/add-and-commit@v9
        with:
          message: "chore(${{ matrix.chart }}): Update images in 'Chart.yaml'"
          default_author: github_actions
          pull: --rebase --autostash