name: Update metadata files for release
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - release-please--**
  schedule:
    - cron: '0 0 * * *'

jobs:
  getCharts:
    runs-on: ubuntu-22.04
    outputs:
      charts: ${{ steps.getCharts.outputs.charts }}
    steps:
      - name: Get changed charts
        id: getCharts
        if: ${{ !github.event.schedule }}
        run: |
          set -ex
          set -o pipefail
          ref="${{ github.ref }}"
          echo "charts=${ref/release-please--branches--main--components--}" | tee $GITHUB_OUTPUT
      - name: Get changed charts
        id: getCharts
        if: ${{ github.event.schedule }}
        run: |
          set -ex
          set -o pipefail
          (
            echo -n charts=
            for chart in charts/*; do
              [[ "$chart" != "charts/*" ]] && echo "$chart"
            done | cut -d / -f 2 | jq -c -Rn '[inputs]'
          )

  extractImages:
    runs-on: ubuntu-22.04
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - run: pip install yq
      - name: Install sponge
        run: sudo apt-get -yq install moreutils

      - name: extract images
        run: ./.github/scripts/extract-artifacthub-images.sh

      - name: Commit Change for single chart
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: [bot] Update images in 'Chart.yaml'"
          default_author: github_actions
          pull: --rebase --autostash

  generateCodeowners:
    if: ${{ !github.event.schedule }}
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - name: generate CODEOWNERS
        run: ./.github/scripts/sync-codeowners.sh > .github/CODEOWNERS

      - uses: EndBug/add-and-commit@v9
        with:
          message: "chore: [bot] Update 'CODEOWNERS'"
          default_author: github_actions
          pull: --rebase --autostash

  generateReadme:
    if: ${{ !github.event.schedule }}
    runs-on: ubuntu-22.04
    needs:
      - getCharts
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - run: pip install json-schema-for-humans
      - name: generate values.md
        run: |
          set -ex
          chart="${{ fromJson(needs.getCharts.outputs.charts)[0] }}"
          generate-schema-doc --config-file .github/json-schema-to-md.yaml "$chart/values.schema.json" "$chart/values.md"
      - name: generate Docs
        uses: docker://jnorwood/helm-docs:latest

      - uses: EndBug/add-and-commit@v9
        with:
          message: "chore: [bot] Update 'README.md'"
          default_author: github_actions
          pull: --rebase --autostash

  extractImagesForMultipleCharts:
    if: ${{ !contains(github.ref, 'release-please--') }}
    runs-on: ubuntu-22.04
    needs:
      - getCharts
    strategy:
      matrix:
        chart: ${{ fromJson(needs.extractImages.outputs.charts) }}
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}

      - run: pip install yq
      - name: Install sponge
        run: sudo apt-get -yq install moreutils

      - name: extract images for ${{ matrix.chart }}
        run: ./.github/scripts/extract-artifacthub-images.sh "${{ matrix.chart }}"

      - uses: EndBug/add-and-commit@v9
        with:
          message: "chore(${{ matrix.chart }}): Update images in 'Chart.yaml'"
          default_author: github_actions
          pull: --rebase --autostash