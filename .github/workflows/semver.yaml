name: Auto-version Charts

on:
  push:
    branches:
      - main
    paths:
      - charts/**
  workflow_dispatch:
    inputs:
      chart:
        type: string
        description: The name of the chart to run against

jobs:
  createReleasePR:
    runs-on: ubuntu-latest
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - id: getChartName
        name: Get name for changed chart
        uses: ./.github/workflows/get-changed-chart.yaml
        with:
          chart: ${{ inputs.chart }}

      - name: Change to github-actions[bot]
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - uses: google-github-actions/release-please-action@v3
        with:
          path: charts/${{ steps.getChartName.outputs.chart }}
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}
          release-type: helm
          monorepo-tags: true
          changelog-types: '[{"type":"feat","section":"Features"},{"type":"fix","section":"Bug Fixes"},{"type":"chore","section":"Miscellaneous Chores"}]'
          pull-request-title-pattern: 'chore${scope}: [bot] release${component}:${version}'
          separate-pull-requests: true
          package-name: ${{ steps.getChartName.outputs.chart }}
          command: release-pr
