name: Auto-version Charts

on:
  push:
    branches:
      - main
    paths:
      - charts/**
  workflow_dispatch: {}

jobs:
  changeFinder:
    runs-on: ubuntu-latest
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: helm/chart-testing-action@v2.3.1

      - id: getChangedChart
        run: |
          set -x
          set -o pipefail
          (
            echo -n changedChart=
            ct list-changed --since "HEAD~" | cut -d / -f 2 | jq -c -Rn '[inputs]'
          ) | tee $GITHUB_OUTPUT
      - id: getLatestReleaseHash
        run: |
          set -x
          set -o pipefail
          chart="${{ steps.getChangedChart.changedChart }}"
          (
            echo -n hash=
            (
              curl -H "Authorization: Bearer ${{ secrets.ACTIONS_BOT_TOKEN }}" "${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/releases" \
                | jq -r ".[] | select(.name | startswith(\"${chart}-\")) | \"\\(.published_at)\\t\\(.target_commitish)\"" \
                | sort -k 1 \
                | tail -n 1 \
                | cut -f 2 \
                | grep -E .
            ) || (
              git rev-list HEAD "charts/$chart" | tail -n 1
            )
          ) | tee $GITHUB_OUTPUT

      - uses: google-github-actions/release-please-action@v3
        with:
          path: charts/${{ steps.getChangedChart.changedChart }}
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}
          release-type: helm
          monorepo-tags: true
          separate-pull-requests: true
          package-name: ${{ steps.getChangedChart.changedChart }}
          command: release-pr
          last-release-sha: ${{ steps.getLatestReleaseHash.hash }}
