name: Get single changed chart

on:
  workflow_call:
    inputs:
      chart:
        type: string
        required: false
        description: The name of the chart to run against
      forPR:
        type: boolean
        required: true
        description: If it should run against the default branch instead of the last commit
    outputs:
      chart:
        description: The name of the changed chart
        value: ${{ jobs.getChangedChart.outputs.chart }}

jobs:
  getChangedChart:
    runs-on: ubuntu-latest
    outputs:
      chart: ${{ steps.getChartName.outputs.chart }}
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: helm/chart-testing-action@v2.4.0
        if: ${{ !inputs.chart }}

      - id: getChangedChart
        if: ${{ !inputs.chart }}
        name: Get changed chart in this commit
        env:
          FOR_PR: ${{ inputs.forPR }}
        run: |
          set -x
          set -o pipefail
          (
            echo -n chart=
            ct_flags=( list-changed )
            if [[ "$FOR_PR" == "false" ]]; then
              ct_flags+=( --since=HEAD~ )
            fi
            ct "${ct_flags[@]}" | cut -d / -f 2
          ) | tee "$GITHUB_OUTPUT"
      - id: getChartName
        name: Get name for changed chart
        run: |
          set -x
          set -o pipefail
          chart="${{ inputs.chart }}"
          chart="${chart:-${{ steps.getChangedChart.outputs.chart }}}"
          chart=${chart:?chart variable is empty}
          (
            echo "chart=${chart}"
          ) | tee "$GITHUB_OUTPUT"
