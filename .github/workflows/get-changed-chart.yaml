name: Auto-version Charts

on:
  workflow_call:
    inputs:
      chart:
        type: string
        required: false
        description: The name of the chart to run against
    outputs:
      chart:
        description: The name of the changed cart in the last commit
        value: ${{ jobs.get_changed_chart.outputs.chart }}

jobs:
  get_changed_chart:
    runs-on: ubuntu-latest
    outputs:
      chart: ${{ steps.getChartName.outputs.chart }}
    env:
      CT_TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: helm/chart-testing-action@v2.3.1
        if: ${{ !inputs.chart }}

      - id: getChangedChart
        if: ${{ !inputs.chart }}
        name: Get changed chart in this commit
        run: |
          set -x
          set -o pipefail
          (
            echo -n chart=
            ct list-changed --since "HEAD~" | cut -d / -f 2
          ) | tee "$GITHUB_OUTPUT"
      - id: getChartName
        name: Get name for changed chart
        run: |
          set -x
          set -o pipefail
          chart="${{ inputs.chart }}"
          chart="${chart:-${{ steps.getChangedChart.outputs.chart }}}"
          chart=${chart:?chart variable is empty}
          (
            echo "chart=${chart}"
          ) | tee "$GITHUB_OUTPUT"
