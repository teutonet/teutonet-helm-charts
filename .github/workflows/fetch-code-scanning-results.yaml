name: Fetch Code Scanning Results

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch: {}

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          token: ${{ secrets.ACTIONS_BOT_TOKEN }}
          fetch-depth: 0

      - name: Switch to code-scanning branch
        run: git switch code-scanning || git switch -c code-scanning

      - name: Fetch code scanning alerts
        id: fetch-alerts
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_BOT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          [[ "$RUNNER_DEBUG" == 1 ]] && set -x
          set -e
          set -o pipefail

          # Fetch all code scanning alerts (100 per page - max allowed)
          echo "Fetching code scanning alerts..."
          gh api --paginate "/repos/${GITHUB_REPOSITORY}/code-scanning/alerts?per_page=100" > all_alerts.json

          # Separate open and closed alerts
          jq '[.[] | select(.state == "open")]' all_alerts.json > open_alerts.json
          jq '[.[] | select(.state != "open")]' all_alerts.json > closed_alerts.json

          echo "Found $(jq length open_alerts.json) open alerts"
          echo "Found $(jq length closed_alerts.json) closed alerts"

      - name: Generate markdown for open alerts
        run: |
          [[ "$RUNNER_DEBUG" == 1 ]] && set -x
          set -e
          set -o pipefail

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          OPEN_COUNT=$(jq length open_alerts.json)

          {
            cat << EOF
          # Open Code Scanning Alerts

          This file is automatically generated daily from the GitHub Code Scanning API.

          **Last Updated:** ${TIMESTAMP}

          **Total Open Alerts:** ${OPEN_COUNT}

          EOF

            if [ "${OPEN_COUNT}" -eq 0 ]; then
              echo
              echo 'âœ… No open code scanning alerts found!'
            else
              jq -r '
                # Define severity order for sorting
                def severity_order:
                  if . == "critical" then 0
                  elif . == "high" then 1
                  elif . == "medium" then 2
                  elif . == "low" then 3
                  else 4
                  end;

                # Extract chart name from path (file:///$CHART:...)
                def extract_chart:
                  .most_recent_instance.location.path // "" |
                  if test("^file:///") then
                    sub("^file:///"; "") | split(":")[0]
                  else
                    "unknown"
                  end;

                # Group by chart and sort
                group_by(extract_chart) |
                map({
                  chart: (.[0] | extract_chart),
                  count: length,
                  alerts: sort_by(.rule.security_severity_level // "unknown" | ascii_downcase | severity_order)
                }) |
                sort_by(.chart) |

                # Generate TOC
                "## Table of Contents\n\n" +
                (map("- [\(.chart)](#\(.chart | gsub("[^a-z0-9-]"; "-"; "g") | ascii_downcase)) (\(.count) alert\(if .count != 1 then "s" else "" end))") | join("\n")) +
                "\n" +

                # Generate sections for each chart
                (map(
                  "\n---\n\n## \(.chart)\n\n**Alert Count:** \(.count)\n\n" +
                  "| Severity | Message | Path | URL |\n" +
                  "|----------|---------|------|-----|\n" +
                  (.alerts | map(
                    "| \(.rule.security_severity_level // "unknown" | ascii_upcase) | \(.rule.description // "N/A") | `\(.most_recent_instance.location.path // "N/A")` | [\(.number)](\(.html_url)) |"
                  ) | join("\n"))
                ) | join("\n"))
              ' open_alerts.json
            fi
          } > open-alerts.md

      - name: Commit and push results
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9
        with:
          add: 'open-alerts.md'
          message: 'docs: Update code scanning results - ${{ github.run_id }}'
          default_author: github_actions
          push: 'origin code-scanning --set-upstream'
